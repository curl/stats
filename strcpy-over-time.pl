#!/usr/bin/perl

require "./stats/tag2date.pm";

sub num {
    my ($t)=@_;
    if($t =~ /^curl-(\d)_(\d+)_(\d+)/) {
        return 10000*$1 + 100*$2 + $3;
    }
    elsif($t =~ /^curl-(\d)_(\d+)/) {
        return 10000*$1 + 100*$2;
    }
}


sub sortthem {
    return num($a) <=> num($b);
}

@alltags= `git tag -l`;

foreach my $t (@alltags) {
    chomp $t;
    if($t =~ /^curl-([0-9_]*[0-9])\z/) {
        push @releases, $t;
    }
}

sub cpyuse {
    my ($tag, $path) = @_;

    # Get source files to count
    my @files;
    open(G, "git ls-tree -r --name-only $tag -- $path 2>/dev/null|");
    while(<G>) {
        chomp;
        if($_ =~ /[ch]\z/) {
            push @files, $_;
        }
    }
    close(G);

    my $cmd;
    for(@files) {
        $cmd .= "$tag:$_ ";
    }

    my $count;
    my $alloc;

    open(G, "git show $cmd 2>/dev/null| grep -E ' strcpy\\('|");
    while(<G>) {
        $count++;
    }
    close(G);

    my $blanks, $comments, $code;
    open(G, "git show $cmd 2>/dev/null| cloc --force-lang=C --csv -|");
    while(<G>) {
        if($_ =~ /^1,SUM,(\d*),(\d*),(\d*)/) {
            ($blanks, $comments, $code)=($1, $2, $3);
            last;
        }
    }
    close(G);

    return ($count, $code);
}

print <<CACHE
2000-03-14;2.222;25
2000-03-21;2.228;25
2000-03-21;2.215;25
2000-08-21;2.264;28
2000-08-30;2.243;28
2000-09-28;2.150;30
2000-10-16;2.090;30
2000-12-04;2.189;32
2001-01-05;2.153;32
2001-01-27;2.404;32
2001-02-13;2.334;32
2001-03-22;2.213;32
2001-04-04;2.278;33
2001-04-23;2.266;33
2001-05-07;2.247;33
2001-06-07;2.223;33
2001-08-20;2.237;33
2001-09-25;2.110;33
2001-11-04;2.024;33
2001-12-05;1.966;33
2002-01-23;1.837;33
2002-02-05;1.834;33
2002-03-07;1.798;33
2002-04-15;1.761;33
2002-05-13;1.726;33
2002-06-13;1.703;33
2002-10-01;1.630;33
2002-10-11;1.625;33
2002-11-18;1.614;33
2003-01-14;1.594;33
2003-04-02;1.658;32
2003-05-19;1.624;32
2003-07-28;1.598;34
2003-08-15;1.553;34
2003-11-01;1.413;32
2004-01-22;1.333;31
2004-03-18;1.060;26
2004-04-26;1.124;28
2004-06-02;1.053;28
2004-08-10;0.940;25
2004-10-18;0.993;27
2004-12-20;0.956;27
2005-02-01;0.913;26
2005-03-04;0.847;25
2005-04-05;0.845;25
2005-05-16;0.823;25
2005-09-01;0.812;25
2005-10-13;0.796;25
2005-12-06;0.789;25
2006-02-27;0.750;24
2006-03-20;0.750;24
2006-06-12;0.650;22
2006-08-07;0.643;22
2006-10-29;0.569;20
2007-01-29;0.626;23
2007-04-11;0.599;23
2007-06-25;0.558;22
2007-07-10;0.576;23
2007-09-13;0.564;23
2007-10-29;0.552;23
2008-01-28;0.590;25
2008-03-30;0.588;25
2008-06-04;0.582;25
2008-09-01;0.572;25
2008-11-05;0.628;28
2008-11-13;0.629;28
2009-01-19;0.628;28
2009-03-02;0.693;32
2009-05-18;0.712;33
2009-08-12;0.768;36
2009-11-04;0.760;36
2010-02-09;0.588;30
2010-04-14;0.582;30
2010-06-16;0.563;31
2010-08-11;0.559;31
2010-10-12;0.555;31
2010-12-15;0.496;28
2011-02-17;0.487;28
2011-04-17;0.482;28
2011-04-22;0.481;28
2011-06-23;0.481;28
2011-09-13;0.494;29
2011-11-14;0.500;30
2011-11-17;0.500;30
2012-01-24;0.494;30
2012-03-22;0.522;32
2012-05-24;0.553;34
2012-07-27;0.535;35
2012-10-10;0.529;35
2012-11-20;0.526;35
2013-02-06;0.494;33
2013-04-12;0.544;37
2013-06-22;0.552;38
2013-08-11;0.549;39
2013-10-13;0.502;36
2013-12-16;0.498;36
2014-01-29;0.496;36
2014-03-26;0.487;36
2014-05-20;0.483;36
2014-07-16;0.479;36
2014-09-10;0.485;37
2014-11-05;0.486;37
2015-01-07;0.497;39
2015-02-25;0.504;39
2015-04-22;0.503;39
2015-04-28;0.503;39
2015-06-17;0.500;39
2015-08-11;0.523;41
2015-10-07;0.522;41
2015-12-01;0.516;41
2016-01-27;0.489;39
2016-02-08;0.488;39
2016-03-23;0.487;39
2016-05-17;0.503;41
2016-05-30;0.503;41
2016-07-21;0.501;41
2016-08-03;0.501;41
2016-09-07;0.499;41
2016-09-14;0.499;41
2016-11-02;0.499;41
2016-12-20;0.490;41
2016-12-22;0.490;41
2017-02-22;0.488;41
2017-02-24;0.488;41
2017-04-19;0.486;41
2017-06-14;0.519;44
2017-08-09;0.518;44
2017-08-13;0.518;44
2017-10-04;0.516;45
2017-10-23;0.514;45
2017-11-29;0.509;45
2018-01-23;0.506;46
2018-03-13;0.503;46
2018-05-15;0.520;48
2018-07-11;0.517;48
2018-09-04;0.516;48
2018-10-30;0.523;50
2018-12-12;0.524;50
2019-02-06;0.523;50
2019-03-27;0.518;50
2019-05-22;0.498;48
2019-06-04;0.498;48
2019-07-17;0.498;48
2019-07-19;0.498;48
2019-09-10;0.492;49
2019-11-05;0.500;50
2020-01-08;0.494;50
2020-03-04;0.499;51
2020-03-11;0.488;50
2020-04-29;0.502;52
2020-06-23;0.497;52
2020-06-30;0.496;52
2020-08-19;0.495;52
2020-10-14;0.473;50
2020-12-09;0.471;50
2021-02-03;0.461;50
2021-03-31;0.459;50
2021-04-14;0.459;50
2021-05-26;0.456;50
2021-07-21;0.459;50
2021-09-14;0.448;49
2021-09-22;0.457;50
2021-11-10;0.454;50
2022-01-05;0.452;50
2022-03-05;0.467;51
2022-04-27;0.471;52
2022-05-11;0.470;52
2022-06-27;0.458;51
2022-08-31;0.464;52
2022-10-26;0.398;45
2022-12-21;0.392;45
2023-02-15;0.363;43
2023-02-20;0.363;43
2023-03-20;0.361;43
2023-03-20;0.361;43
2023-05-17;0.349;43
2023-05-23;0.349;43
2023-05-30;0.350;43
2023-07-19;0.348;43
2023-07-26;0.348;43
2023-09-13;0.335;41
2023-10-11;0.335;41
2023-12-06;0.349;43
2024-01-31;0.358;45
2024-03-27;0.352;45
2024-03-27;0.352;45
2024-05-22;0.346;45
2024-07-24;0.339;45
2024-07-31;0.339;45
2024-09-11;0.350;47
2024-09-18;0.350;47
2024-11-06;0.230;31
2024-12-11;0.229;31
2025-02-05;0.220;30
2025-02-13;0.221;30
2025-04-02;0.203;28
2025-05-28;0.199;28
2025-06-04;0.199;28
2025-07-16;0.210;29
2025-09-10;0.209;29
2025-11-05;0.188;26
CACHE
    ;

sub show {
    my ($t, $d) = @_;
    my ($cpy, $code) = cpyuse($t, "lib src");
    printf "$d;%.3f;%u\n", $cpy * 1000 / $code, $cpy;
}

foreach my $t (sort sortthem @releases) {
    if(num($t) <= 81700) {
        next;
    }
    my $d = tag2date($t);
    show($t, $d);
}

$t=`git describe --match "curl*"`;
chomp $t;

my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) =
    localtime(time);
my $d = sprintf "%04d-%02d-%02d", $year + 1900, $mon + 1, $mday;

show($t, $d);
