#!/usr/bin/perl

require "./stats/tag2date.pm";

sub num {
    my ($t)=@_;
    if($t =~ /^curl-(\d)_(\d+)_(\d+)/) {
        return 10000*$1 + 100*$2 + $3;
    }
    elsif($t =~ /^curl-(\d)_(\d+)/) {
        return 10000*$1 + 100*$2;
    }
}


sub sortthem {
    return num($a) <=> num($b);
}

@alltags= `git tag -l`;

foreach my $t (@alltags) {
    chomp $t;
    if($t =~ /^curl-([0-9_]*[0-9])\z/) {
        push @releases, $t;
    }
}

sub ifuse {
    my ($tag, $path) = @_;

    # Get source files to count
    my @files;
    open(G, "git ls-tree -r --name-only $tag -- $path 2>/dev/null|");
    while(<G>) {
        chomp;
        if($_ =~ /[ch]\z/) {
            push @files, $_;
        }
    }
    close(G);

    my $cmd;
    for(@files) {
        $cmd .= "$tag:$_ ";
    }

    my $count;
    my $alloc;

    open(G, "git show $cmd 2>/dev/null| grep -Ea '^ *# *(if|elif)'|");
    while(<G>) {
        $count++;
    }
    close(G);

    return ($count, $code);
}

print <<CACHE
2000-03-14;357
2000-03-21;354
2000-03-21;354
2000-08-21;409
2000-08-30;421
2000-09-28;461
2000-10-16;488
2000-12-04;477
2001-01-05;481
2001-01-27;466
2001-02-13;489
2001-03-22;502
2001-04-04;498
2001-04-23;503
2001-05-07;506
2001-06-07;508
2001-08-20;511
2001-09-25;517
2001-11-04;530
2001-12-05;546
2002-01-23;581
2002-02-05;582
2002-03-07;591
2002-04-15;602
2002-05-13;607
2002-06-13;647
2002-10-01;674
2002-10-11;674
2002-11-18;678
2003-01-14;685
2003-04-02;601
2003-05-19;603
2003-07-28;650
2003-08-15;664
2003-11-01;694
2004-01-22;737
2004-03-18;799
2004-04-26;808
2004-06-02;919
2004-08-10;900
2004-10-18;908
2004-12-20;978
2005-02-01;979
2005-03-04;978
2005-04-05;993
2005-05-16;1029
2005-09-01;1043
2005-10-13;1060
2005-12-06;1079
2006-02-27;1090
2006-03-20;1090
2006-06-12;1167
2006-08-07;1189
2006-10-29;1228
2007-01-29;1313
2007-04-11;1367
2007-06-25;1411
2007-07-10;1437
2007-09-13;1422
2007-10-29;1455
2008-01-28;1480
2008-03-30;1496
2008-06-04;1517
2008-09-01;1509
2008-11-05;1522
2008-11-13;1517
2009-01-19;1510
2009-03-02;1566
2009-05-18;1569
2009-08-12;1606
2009-11-04;1661
2010-02-09;1754
2010-04-14;1782
2010-06-16;1819
2010-08-11;1841
2010-10-12;1857
2010-12-15;1907
2011-02-17;1953
2011-04-17;1951
2011-04-22;1931
2011-06-23;1923
2011-09-13;1925
2011-11-14;1985
2011-11-17;1985
2012-01-24;2004
2012-03-22;2019
2012-05-24;1974
2012-07-27;2132
2012-10-10;2162
2012-11-20;2176
2013-02-06;2130
2013-04-12;2180
2013-06-22;2180
2013-08-11;2224
2013-10-13;2236
2013-12-16;2251
2014-01-29;2260
2014-03-26;2284
2014-05-20;2292
2014-07-16;2312
2014-09-10;2335
2014-11-05;2343
2015-01-07;2460
2015-02-25;2470
2015-04-22;2474
2015-04-28;2476
2015-06-17;2479
2015-08-11;2485
2015-10-07;2489
2015-12-01;2522
2016-01-27;2532
2016-02-08;2541
2016-03-23;2557
2016-05-17;2620
2016-05-30;2633
2016-07-21;2643
2016-08-03;2643
2016-09-07;2647
2016-09-14;2650
2016-11-02;2628
2016-12-20;2654
2016-12-22;2654
2017-02-22;2673
2017-02-24;2676
2017-04-19;2696
2017-06-14;2702
2017-08-09;2697
2017-08-13;2697
2017-10-04;2719
2017-10-23;2724
2017-11-29;2747
2018-01-23;2770
2018-03-13;2791
2018-05-15;2809
2018-07-11;2866
2018-09-04;2871
2018-10-30;2927
2018-12-12;2928
2019-02-06;2951
2019-03-27;2980
2019-05-22;3058
2019-06-04;3062
2019-07-17;3056
2019-07-19;3056
2019-09-10;3120
2019-11-05;3137
2020-01-08;3175
2020-03-04;3201
2020-03-11;3216
2020-04-29;3248
2020-06-23;3395
2020-06-30;3380
2020-08-19;3416
2020-10-14;3383
2020-12-09;3381
2021-02-03;3437
2021-03-31;3442
2021-04-14;3441
2021-05-26;3475
2021-07-21;3441
2021-09-14;3466
2021-09-22;3465
2021-11-10;3484
2022-01-05;3516
2022-03-05;3439
2022-04-27;3456
2022-05-11;3463
2022-06-27;3535
2022-08-31;3604
2022-10-26;3659
2022-12-21;3616
2023-02-15;3660
2023-02-20;3666
2023-03-20;3672
2023-03-20;3672
2023-05-17;3693
2023-05-23;3689
2023-05-30;3692
2023-07-19;3710
2023-07-26;3710
2023-09-13;3715
2023-10-11;3608
2023-12-06;3606
2024-01-31;3653
2024-03-27;3700
2024-03-27;3700
2024-05-22;3825
2024-07-24;3888
2024-07-31;3890
2024-09-11;3925
2024-09-18;3934
2024-11-06;3985
2024-12-11;4000
2025-02-05;4030
2025-02-13;3981
2025-04-02;4077
2025-05-28;4163
2025-06-04;4159
2025-07-16;4087
2025-09-10;4065
2025-11-05;4054
2026-01-07;3864
CACHE
    ;

sub show {
    my ($t, $d) = @_;
    my ($ifdefs) = ifuse($t, "lib src");
    printf "$d;%u\n", $ifdefs;
}

foreach my $t (sort sortthem @releases) {
    if(num($t) <= 81800) {
        next;
    }
    my $d = tag2date($t);
    show($t, $d);
}

$t=`git describe --match "curl*"`;
chomp $t;

my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) =
    localtime(time);
my $d = sprintf "%04d-%02d-%02d", $year + 1900, $mon + 1, $mday;

show($t, $d);
