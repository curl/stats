#!/usr/bin/perl

require "./stats/tag2date.pm";

sub num {
    my ($t)=@_;
    if($t =~ /^curl-(\d)_(\d+)_(\d+)/) {
        return 10000*$1 + 100*$2 + $3;
    }
    elsif($t =~ /^curl-(\d)_(\d+)/) {
        return 10000*$1 + 100*$2;
    }
}


sub sortthem {
    return num($a) <=> num($b);
}

@alltags= `git tag -l`;

foreach my $t (@alltags) {
    chomp $t;
    if($t =~ /^curl-([0-9_]*[0-9])\z/) {
        push @releases, $t;
    }
}

sub linecount {
    my ($tag, $path) = @_;

    # Get source files to count
    my @files;
    open(G, "git ls-tree -r --name-only $tag -- $path 2>/dev/null|");
    while(<G>) {
        chomp;
        push @files, $_;
    }
    close(G);

    my $cmd;
    for(@files) {
        $cmd .= "$tag:$_ ";
    }

    my $blanks, $comments, $code;
    open(G, "git show $cmd 2>/dev/null| wc -l |");
    while(<G>) {
        if($_ =~ /^(\d*)/) {
            $lines = $1;
            last;
        }
    }
    close(G);

    return ($lines);
}

print <<CACHE
2000-03-14;25
2000-03-21;25
2000-03-21;25
2000-08-21;25
2000-08-30;25
2000-09-28;25
2000-10-16;25
2000-12-04;1960
2001-01-05;1960
2001-01-27;2108
2001-02-13;2263
2001-03-22;2541
2001-04-04;2540
2001-04-23;2540
2001-05-07;2914
2001-06-07;2749
2001-08-20;3684
2001-09-25;4541
2001-11-04;5154
2001-12-05;5310
2002-01-23;5402
2002-02-05;5432
2002-03-07;6197
2002-04-15;6395
2002-05-13;6392
2002-06-13;6770
2002-10-01;6893
2002-10-11;7149
2002-11-18;7343
2003-01-14;8091
2003-04-02;8526
2003-05-19;9288
2003-07-28;10409
2003-08-15;11779
2003-11-01;12836
2004-01-22;13647
2004-03-18;14251
2004-04-26;16048
2004-06-02;16675
2004-08-10;17392
2004-10-18;18125
2004-12-20;20554
2005-02-01;21159
2005-03-04;21408
2005-04-05;22339
2005-05-16;25460
2005-09-01;26468
2005-10-13;27614
2005-12-06;27830
2006-02-27;28022
2006-03-20;28098
2006-06-12;28476
2006-08-07;28595
2006-10-29;31050
2007-01-29;32981
2007-04-11;35019
2007-06-25;36661
2007-07-10;36662
2007-09-13;37749
2007-10-29;39445
2008-01-28;42472
2008-03-30;43324
2008-06-04;44782
2008-09-01;51273
2008-11-05;52650
2008-11-13;52923
2009-01-19;53278
2009-03-02;53687
2009-05-18;54893
2009-08-12;56388
2009-11-04;56998
2010-02-09;63667
2010-04-14;64237
2010-06-16;66243
2010-08-11;66489
2010-10-12;67426
2010-12-15;67791
2011-02-17;69361
2011-04-17;71174
2011-04-22;71592
2011-06-23;73813
2011-09-13;74992
2011-11-14;77033
2011-11-17;77033
2012-01-24;79511
2012-03-22;80991
2012-05-24;81455
2012-07-27;88130
2012-10-10;91225
2012-11-20;92174
2013-02-06;93472
2013-04-12;97135
2013-06-22;98501
2013-08-11;99323
2013-10-13;101440
2013-12-16;104267
2014-01-29;105556
2014-03-26;106342
2014-05-20;107947
2014-07-16;108023
2014-09-10;108153
2014-11-05;108818
2015-01-07;109966
2015-02-25;110995
2015-04-22;111186
2015-04-28;111265
2015-06-17;111610
2015-08-11;111947
2015-10-07;112040
2015-12-01;113302
2016-01-27;113672
2016-02-08;114030
2016-03-23;114060
2016-05-17;115953
2016-05-30;115954
2016-07-21;116673
2016-08-03;116673
2016-09-07;116942
2016-09-14;117037
2016-11-02;117800
2016-12-20;118957
2016-12-22;118880
2017-02-22;120259
2017-02-24;120262
2017-04-19;121279
2017-06-14;123122
2017-08-09;142748
2017-08-13;142881
2017-10-04;146872
2017-10-23;147007
2017-11-29;149344
2018-01-23;150585
2018-03-13;151781
2018-05-15;152838
2018-07-11;153677
2018-09-04;154239
2018-10-30;156266
2018-12-12;156968
2019-02-06;158514
2019-03-27;159431
2019-05-22;160940
2019-06-04;161035
2019-07-17;161395
2019-07-19;161395
2019-09-10;162265
2019-11-05;163498
2020-01-08;165024
2020-03-04;167211
2020-03-11;168953
2020-04-29;154030
2020-06-23;155034
2020-06-30;155332
2020-08-19;156227
2020-10-14;155911
2020-12-09;155860
2021-02-03;157696
2021-03-31;158686
2021-04-14;158781
2021-05-26;159457
2021-07-21;158832
2021-09-14;159803
2021-09-22;159948
2021-11-10;161666
2022-01-05;163211
2022-03-05;163686
2022-04-27;165651
2022-05-11;166063
2022-06-27;168079
2022-08-31;168536
2022-10-26;170851
2022-12-21;174367
2023-02-15;180777
2023-02-20;180958
2023-03-20;183150
2023-03-20;183150
2023-05-17;187682
2023-05-23;187750
2023-05-30;187914
2023-07-19;189156
2023-07-26;189256
2023-09-13;192288
2023-10-11;193639
2023-12-06;195038
2024-01-31;195422
2024-03-27;196730
2024-03-27;196730
2024-05-22;202102
2024-07-24;204831
2024-07-31;204912
2024-09-11;207013
2024-09-18;207963
2024-11-06;208812
2024-12-11;209413
CACHE
    ;

sub show {
    my ($t, $d) = @_;
    my ($lines) = linecount($t, "tests");
    printf "$d;%u\n", $lines;
}

foreach my $t (sort sortthem @releases) {
    if(num($t) <= 81101) {
        next;
    }
    my $d = tag2date($t);
    show($t, $d);
}

$t=`git describe`;
chomp $t;

my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) =
    localtime(time);
my $d = sprintf "%04d-%02d-%02d", $year + 1900, $mon + 1, $mday;

show($t, $d);
