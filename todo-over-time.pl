#!/usr/bin/perl

require "./stats/tag2date.pm";

sub num {
    my ($t)=@_;
    if($t =~ /^curl-(\d)_(\d+)_(\d+)/) {
        return 10000*$1 + 100*$2 + $3;
    }
    elsif($t =~ /^curl-(\d)_(\d+)/) {
        return 10000*$1 + 100*$2;
    }
}


sub sortthem {
    return num($a) <=> num($b);
}

@alltags= `git tag -l`;

foreach my $t (@alltags) {
    chomp $t;
    if($t =~ /^curl-([0-9_]*[0-9])\z/) {
        push @releases, $t;
    }
}

my @exts = (".md", "");

sub options {
    my ($tag, $file) = @_;
    my @t;
    my $old = 1;
    foreach my $e (@exts) {
        my $f .= $file . $e;
        @t = `git show $tag:$f 2>/dev/null`;
        if($t[0]) {
            if($e) {
                $old = 0;
            }
            last;
        }
    }
    my $c =0;
    if(num($tag) < 71800) {
        # before 7.18.0 TODO was different
        foreach $l (@t) {
            if($l =~ /^ \* /) {
                $c++;
            }
        }
    }
    elsif(num($tag) < 71300) {
        # known bugs before 7.13.0
        foreach $l (@t) {
            if($l =~ /^\* /) {
                $c++;
            }
        }
    }
    elsif(num($tag) < 74900) {
        # before 7.49.0 KNOWN_BUGS was different
        foreach $l (@t) {
            if($l =~ /^\d+\. /) {
                $c++;
            }
        }
    }
    elsif($old) {
        foreach $l (@t) {
            if($l =~ /^\d+\.\d+/) {
                $c++;
            }
        }
    }
    else {
        # with extension,  since mid 8.17.0 cycle
        foreach $l (@t) {
            if($l =~ /^\#\# /) {
                $c++;
            }
        }
    }
    return $c;
}

print <<CACHE
2000-08-21;17;
2000-08-30;17;
2000-09-28;15;
2000-10-16;17;
2000-12-04;20;
2001-01-05;20;
2001-01-27;18;
2001-02-13;18;
2001-03-22;17;
2001-04-04;17;
2001-04-23;16;
2001-05-07;16;
2001-06-07;15;
2001-08-20;23;
2001-09-25;19;
2001-11-04;23;
2001-12-05;24;
2002-01-23;33;
2002-02-05;33;
2002-03-07;38;3
2002-04-15;38;8
2002-05-13;37;7
2002-06-13;36;7
2002-10-01;40;9
2002-10-11;40;9
2002-11-18;39;9
2003-01-14;37;9
2003-04-02;40;10
2003-05-19;42;11
2003-07-28;37;12
2003-08-15;36;15
2003-11-01;33;17
2004-01-22;34;18
2004-03-18;38;12
2004-04-26;43;10
2004-06-02;44;11
2004-08-10;44;11
2004-10-18;47;13
2004-12-20;46;13
2005-02-01;54;18
2005-03-04;54;19
2005-04-05;54;20
2005-05-16;53;19
2005-09-01;61;20
2005-10-13;61;21
2005-12-06;60;22
2006-02-27;63;25
2006-03-20;63;23
2006-06-12;61;24
2006-08-07;62;23
2006-10-29;61;23
2007-01-29;60;27
2007-04-11;60;26
2007-06-25;60;27
2007-07-10;60;27
2007-09-13;66;30
2007-10-29;66;28
2008-01-28;15;29
2008-03-30;15;28
2008-06-04;15;31
2008-09-01;15;33
2008-11-05;15;32
2008-11-13;15;32
2009-01-19;15;36
2009-03-02;15;34
2009-05-18;15;37
2009-08-12;15;44
2009-11-04;15;44
2010-02-09;15;43
2010-04-14;15;44
2010-06-16;15;44
2010-08-11;15;44
2010-10-12;15;43
2010-12-15;15;43
2011-02-17;15;43
2011-04-17;15;43
2011-04-22;15;43
2011-06-23;15;43
2011-09-13;15;43
2011-11-14;15;42
2011-11-17;15;42
2012-01-24;15;44
2012-03-22;15;44
2012-05-24;17;44
2012-07-27;19;46
2012-10-10;20;45
2012-11-20;20;45
2013-02-06;19;45
2013-04-12;19;45
2013-06-22;19;47
2013-08-11;19;46
2013-10-13;19;47
2013-12-16;19;50
2014-01-29;19;50
2014-03-26;19;50
2014-05-20;19;49
2014-07-16;19;47
2014-09-10;19;46
2014-11-05;19;46
2015-01-07;19;47
2015-02-25;21;47
2015-04-22;21;49
2015-04-28;21;49
2015-06-17;21;49
2015-08-11;21;49
2015-10-07;21;47
2015-12-01;21;47
2016-01-27;21;47
2016-02-08;21;47
2016-03-23;21;49
2016-05-17;99;47
2016-05-30;99;47
2016-07-21;100;48
2016-08-03;102;51
2016-09-07;109;53
2016-09-14;109;53
2016-11-02;120;57
2016-12-20;118;56
2016-12-22;118;56
2017-02-22;120;54
2017-02-24;122;54
2017-04-19;121;54
2017-06-14;120;53
2017-08-09;119;53
2017-08-13;119;53
2017-10-04;115;53
2017-10-23;115;53
2017-11-29;115;53
2018-01-23;118;53
2018-03-13;122;54
2018-05-15;124;58
2018-07-11;125;60
2018-09-04;127;60
2018-10-30;127;60
2018-12-12;127;61
2019-02-06;128;63
2019-03-27;133;67
2019-05-22;131;67
2019-06-04;131;67
2019-07-17;131;69
2019-07-19;131;69
2019-09-10;110;69
2019-11-05;112;70
2020-01-08;114;72
2020-03-04;117;71
2020-03-11;117;72
2020-04-29;122;74
2020-06-23;127;75
2020-06-30;129;75
2020-08-19;131;77
2020-10-14;134;79
2020-12-09;134;93
2021-02-03;129;99
2021-03-31;130;102
2021-04-14;129;102
2021-05-26;128;106
2021-07-21;129;109
2021-09-14;130;118
2021-09-22;131;119
2021-11-10;130;120
2022-01-05;132;122
2022-03-05;128;114
2022-04-27;131;114
2022-05-11;131;116
2022-06-27;130;115
2022-08-31;130;121
2022-10-26;132;120
2022-12-21;132;91
2023-02-15;134;82
2023-02-20;134;82
2023-03-20;134;80
2023-03-20;134;80
2023-05-17;137;61
2023-05-23;138;62
2023-05-30;138;62
2023-07-19;137;62
2023-07-26;137;63
2023-09-13;137;71
2023-10-11;137;71
2023-12-06;138;67
2024-01-31;139;67
2024-03-27;139;72
2024-03-27;139;72
2024-05-22;138;73
2024-07-24;137;78
2024-07-31;138;78
2024-09-11;136;66
2024-09-18;136;66
2024-11-06;136;67
2024-12-11;137;68
2025-02-05;137;69
2025-02-13;137;69
2025-04-02;136;69
2025-05-28;135;68
2025-06-04;135;67
2025-07-16;134;66
2025-09-10;131;67
2025-11-05;125;67
CACHE
    ;

foreach my $t (sort sortthem @releases) {
    if(num($t) <= 81700) {
        next;
    }
    my $d = tag2date($t);
    my $n = options($t, "docs/TODO");
    my $k = options($t, "docs/KNOWN_BUGS");

    if($n || $k) {
        # prettyfy
        $t =~ s/_/./g;
        $t =~ s/-/ /g;
        printf "$d;$n;%s\n", $k ? $k : "";
    }
}

$t=`git describe --match "curl*"`;
chomp $t;

my $n = options($t, "docs/TODO");
my $k = options($t, "docs/KNOWN_BUGS");
my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) =
    localtime(time);
$date = sprintf "%04d-%02d-%02d", $year + 1900, $mon + 1, $mday;
print "$date;$n;$k\n";
