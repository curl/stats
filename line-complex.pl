#!/usr/bin/perl

require "./stats/tag2date.pm";
require "./stats/median.pm";

sub num {
    my ($t)=@_;
    if($t =~ /^curl-(\d)_(\d+)_(\d+)/) {
        return 10000*$1 + 100*$2 + $3;
    }
    elsif($t =~ /^curl-(\d)_(\d+)/) {
        return 10000*$1 + 100*$2;
    }
}

sub sortthem {
    return num($a) <=> num($b);
}

@alltags= `git tag -l`;

foreach my $t (@alltags) {
    chomp $t;
    if($t =~ /^curl-([0-9_]*[0-9])\z/) {
        push @releases, $t;
    }
}

sub p99 {
    my @a = @_;
    my @vals = sort {$b <=> $a} @a;
    my $i = scalar(@vals) * 0.01;
    return $vals[$i];
}

sub p90 {
    my @a = @_;
    my @vals = sort {$b <=> $a} @a;
    my $i = scalar(@vals) * 0.1;
    return $vals[$i];
}

sub worst {
    my @a = @_;
    my @vals = sort {$b <=> $a} @a;
    return $vals[0];
}

sub complexity {
    my ($tag, $path) = @_;

    # Get source files to count
    my @files;
    open(G, "git ls-tree -r --name-only $tag -- $path 2>/dev/null|");
    while(<G>) {
        chomp;
        if($_ =~ /[ch]\z/) {
            push @files, $_;
        }
    }
    close(G);

    my $cmd;
    for(@files) {
        $cmd .= "$tag:$_ ";
    }

    #  Modified McCabe Cyclomatic Complexity
    #  |   Traditional McCabe Cyclomatic Complexity
    #  |       |    # Statements in function
    #  |       |        |   First line of function
    #  |       |        |       |   # lines in function
    #  |       |        |       |       |

    my $score;
    my $funcs;
    my $totlines;
    my @lines; # one score for each line

    open(G, "git show $cmd 2>/dev/null| pmccabe 2>/dev/null|");
    while(<G>) {
        if($_ =~ /^(\d+)\t(\d+)\t(\d+)\t(\d+)\t(\d+)/) {
            my ($modmccabe, $mccabe, $statements, $first, $lines)=($1, $2, $3, $4, $5);
            if($modmccabe > 1000) {
                # something is wrong
                #print STDERR $_;
                return 0;
            }
            $score += $modmccabe * $lines;
            for(1 .. $lines) {
                push @lines, $modmccabe;
            }
            $funcs++;
            $totlines += $lines;
        }
    }
    close(G);
    #print STDERR "$score for $totlines\n";
    return $score / $totlines, median(@lines);
}

print <<CACHE
2000-03-14;38.698;22.0
2000-03-21;38.481;22.0
2000-03-21;38.322;22.0
2000-08-21;36.502;20.0
2000-08-30;36.545;20.0
2000-09-28;36.977;18.0
2000-10-16;36.696;18.0
2000-12-04;38.629;18.0
2001-01-05;38.244;18.0
2001-01-27;45.544;24.0
2001-02-13;49.409;24.0
2001-03-22;48.873;24.0
2001-04-04;49.316;26.0
2001-04-23;49.435;26.0
2001-05-07;49.547;26.0
2001-06-07;50.352;26.0
2001-08-20;50.096;26.0
2001-09-25;47.462;24.0
2001-11-04;42.219;22.0
2001-12-05;42.551;24.0
2002-01-23;41.434;22.0
2002-02-05;41.637;22.0
2002-03-07;42.017;22.0
2002-04-15;42.314;22.0
2002-05-13;42.362;22.0
2002-06-13;43.621;24.0
2002-10-01;44.155;25.0
2002-10-11;44.067;26.0
2002-11-18;45.413;26.0
2003-01-14;45.782;26.0
2003-04-02;46.216;22.0
2003-05-19;47.078;22.0
2003-07-28;48.977;21.0
2003-08-15;48.463;21.0
2003-11-01;46.237;21.0
2004-01-22;46.476;21.0
2004-03-18;41.726;19.0
2004-04-26;45.682;20.0
2004-06-02;46.907;20.0
2004-08-10;47.161;20.0
2004-10-18;47.794;20.0
2004-12-20;48.653;19.0
2005-02-01;48.622;18.0
2005-03-04;46.491;17.0
2005-04-05;46.544;17.0
2005-05-16;45.731;17.0
2005-09-01;46.374;17.0
2005-10-13;46.149;17.0
2005-12-06;46.154;17.0
2006-02-27;45.982;18.0
2006-03-20;45.997;18.0
2006-06-12;44.156;16.0
2006-08-07;44.226;16.0
2006-10-29;42.367;16.0
2007-01-29;42.688;17.0
2007-04-11;43.066;18.0
2007-06-25;42.752;17.0
2007-07-10;42.572;18.0
2007-09-13;44.223;17.0
2007-10-29;45.012;17.0
2008-01-28;45.541;17.0
2008-03-30;46.427;17.0
2008-06-04;46.664;17.0
2008-09-01;41.552;18.0
2008-11-05;41.524;16.0
2008-11-13;41.505;16.0
2009-01-19;42.227;17.0
2009-03-02;42.278;17.0
2009-05-18;42.360;17.0
2009-08-12;44.164;17.0
2009-11-04;44.681;18.0
2010-02-09;43.419;16.0
2010-04-14;42.772;15.0
2010-06-16;42.549;16.0
2010-08-11;42.717;16.0
2010-10-12;42.728;14.0
2010-12-15;42.993;14.0
2011-02-17;42.908;15.0
2011-04-17;42.927;15.0
2011-04-22;43.399;15.0
2013-04-12;45.483;14.0
2013-06-22;45.073;14.0
2013-08-11;44.711;14.0
2013-10-13;45.034;14.0
2013-12-16;45.043;13.0
2014-01-29;44.983;13.0
2014-03-26;43.321;13.0
2014-05-20;43.497;13.0
2014-07-16;43.477;13.0
2014-09-10;43.178;13.0
2014-11-05;43.649;13.0
2015-01-07;43.238;13.0
2015-02-25;44.010;14.0
2015-04-22;44.091;14.0
2015-04-28;44.130;14.0
2015-06-17;44.268;14.0
2015-08-11;44.142;14.0
2015-10-07;44.356;14.0
2015-12-01;44.193;14.0
2016-01-27;44.480;14.0
2016-02-08;44.377;14.0
2016-03-23;44.354;14.0
2016-05-17;45.019;14.0
2016-05-30;45.002;14.0
2016-07-21;45.048;14.0
2016-08-03;45.045;14.0
2016-09-07;45.023;14.0
2016-09-14;45.027;14.0
2016-11-02;45.152;14.0
2016-12-20;46.634;14.0
2016-12-22;46.634;14.0
2017-02-22;47.234;15.0
2017-02-24;47.376;15.0
2017-04-19;46.687;15.0
2017-06-14;46.812;15.0
2017-08-09;47.265;15.0
2017-08-13;47.280;15.0
2017-10-04;47.557;14.0
2017-10-23;49.411;14.0
2017-11-29;49.217;14.0
2018-01-23;50.392;15.0
2018-03-13;50.447;15.0
2018-05-15;50.576;15.0
2018-07-11;50.697;15.0
2018-09-04;51.220;15.0
2018-10-30;50.753;15.0
2018-12-12;51.203;15.0
2019-02-06;51.233;15.0
2019-03-27;51.757;15.0
2019-05-22;51.744;16.0
2019-06-04;51.741;16.0
2019-07-17;51.650;15.0
2019-07-19;51.650;15.0
2019-09-10;47.406;15.0
2019-11-05;47.433;15.0
2020-01-08;47.454;15.0
2020-03-04;47.602;15.0
2020-03-11;47.698;15.0
2020-04-29;47.538;15.0
2020-06-23;48.591;15.0
2020-06-30;48.564;15.0
2020-08-19;48.527;15.0
2020-10-14;48.947;15.0
2020-12-09;48.986;15.0
2021-02-03;45.744;15.0
2021-03-31;46.161;15.0
2021-04-14;46.067;15.0
2021-05-26;46.452;15.0
2021-07-21;45.850;15.0
2021-09-14;45.799;15.0
2021-09-22;45.795;15.0
2021-11-10;45.969;15.0
2022-01-05;45.963;15.0
2022-03-05;46.019;15.0
2022-04-27;45.940;15.0
2022-05-11;45.956;15.0
2022-06-27;46.248;15.0
2022-08-31;46.471;15.0
2022-10-26;45.977;15.0
2022-12-21;45.105;15.0
2023-02-15;43.943;14.0
2023-02-20;43.978;14.0
2023-03-20;44.013;14.0
2023-03-20;44.012;14.0
2023-05-17;42.775;13.0
2023-05-23;42.772;13.0
2023-05-30;42.860;13.0
2023-07-19;42.884;13.0
2023-07-26;42.891;13.0
2023-09-13;43.565;14.0
2023-10-11;43.575;14.0
2023-12-06;41.630;14.0
2024-01-31;39.425;13.0
2024-03-27;38.537;13.0
2024-03-27;38.537;13.0
2024-05-22;38.962;13.0
2024-07-24;38.507;12.0
2024-07-31;38.497;12.0
2024-09-11;38.764;12.0
2024-09-18;38.539;12.0
2024-11-06;28.146;12.0
2024-12-11;26.565;12.0
2025-02-05;26.594;12.0
2025-02-13;26.451;12.0
2025-04-02;25.786;11.0
2025-05-28;20.825;11.0
2025-06-04;19.947;11.0
2025-07-16;18.735;11.0
2025-09-10;17.202;11.0
2025-11-05;17.274;11.0
2026-01-07;17.114;11.0
CACHE
    ;

sub show {
    my ($t, $d) = @_;
    my ($score, $med) = complexity($t, "src lib");
    if($score) {
        printf "$d;%.3f;%.1f\n", $score, $med;
    }

}

foreach my $t (sort sortthem @releases) {
    if(num($t) <= 81800) {
        next;
    }
    my $d = tag2date($t);
    show($t, $d);
}

$t=`git describe --match "curl*"`;
chomp $t;

my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) =
    localtime(time);
my $d = sprintf "%04d-%02d-%02d", $year + 1900, $mon + 1, $mday;

show($t, $d);
