#!/usr/bin/perl

chdir "stats";

print <<CACHE
2020-03-20;20;23
2020-03-20;21;25
2020-03-20;22;26
2020-03-24;22;31
2020-03-24;23;33
2020-03-25;24;37
2020-03-27;24;38
2020-03-27;24;39
2020-04-22;25;40
2020-04-22;25;41
2020-04-22;25;42
2020-04-23;25;43
2020-04-26;27;48
2020-04-27;28;52
2020-05-15;29;55
2020-05-16;30;57
2020-06-05;32;60
2020-06-08;32;61
2020-09-08;33;62
2020-09-10;34;65
2020-09-11;34;66
2020-09-29;34;65
2020-09-29;35;68
2020-09-29;35;70
2020-10-06;35;71
2020-10-15;35;72
2020-11-11;36;77
2020-11-17;37;79
2020-12-01;37;81
2020-12-17;37;82
2020-12-18;38;85
2021-01-14;38;86
2021-02-12;39;88
2021-02-19;40;90
2021-03-09;40;91
2021-03-09;40;94
2021-03-09;40;95
2021-03-10;40;96
2021-03-10;40;97
2021-04-09;41;98
2021-04-09;41;100
2021-04-30;41;101
2021-05-04;41;100
2021-06-11;41;101
2021-06-14;41;102
2021-06-16;42;102
2021-06-16;42;103
2021-07-01;43;105
2021-07-01;43;106
2021-07-04;44;107
2021-07-05;45;108
2021-07-07;45;109
2021-09-16;45;111
2021-09-17;46;112
2021-09-22;46;112
2021-09-23;47;115
2021-10-07;48;118
2021-12-22;49;121
2021-12-22;48;120
2022-01-24;48;121
2022-03-09;51;130
2022-04-26;51;142
2022-11-28;51;143
2023-01-04;52;143
2023-01-04;52;146
2023-01-04;54;146
2023-01-04;54;152
2023-03-24;54;153
2023-05-26;55;155
2023-06-12;56;160
2023-06-14;57;161
2023-06-22;58;163
2023-10-23;58;164
2023-12-08;58;166
2023-12-12;58;168
2023-12-13;59;170
2024-01-29;60;171
2024-01-29;61;172
2024-02-08;62;173
2024-02-08;63;174
2024-02-08;64;175
2024-02-20;63;174
2024-02-20;64;176
2024-02-22;64;179
2024-04-29;65;180
2024-04-30;65;184
2024-04-30;66;186
2024-05-16;66;188
2024-05-23;67;192
2024-06-03;68;193
2024-07-11;69;195
2024-09-02;70;196
2024-09-08;71;200
2024-09-09;71;200
2024-09-09;73;203
2024-09-09;74;205
2024-09-18;75;207
2024-09-18;75;208
2024-09-19;75;209
2024-10-07;76;210
2024-10-09;77;212
2024-10-10;77;211
2024-10-16;77;212
2024-10-22;79;216
2024-10-24;79;216
2024-10-28;79;217
2024-10-30;80;227
2024-10-30;80;230
2024-10-31;80;231
2024-12-05;81;233
2024-12-06;81;232
2024-12-21;82;234
CACHE
    ;

open(L, "git log --reverse --pretty=fuller --date=short --stat --since=2025-01-06 |");
my $hash;
my $prev="0.0";
while(<L>) {
    chomp;
    my $line = $_;
    # store the date first
    if($line =~ /^commit (.*)/) {
        $hash = $1;
    }
    elsif($line =~ /^CommitDate:([ \t]*)(.*)/) {
        my $date = $2;

        if($date =~ /^(\d\d\d\d)-(\d\d)-(\d\d)/) {
            $day = "$1-$2-$3";
        }
        my @files = gnuplots($hash);
        my $gr = graphs($hash, @files);
        my $files = scalar(@files);
        if($prev ne "$gr.$files") {
            # only output new output
            printf "%s;%d;%d\n", $day, $files, $gr;
            $prev = "$gr.$files";
        }
    }
}


sub gnuplots {
    my ($tag)=@_;
    open(G, "git show $tag:mksvg.sh 2>/dev/null |");
    my @rl = <G>;
    close(G);
    my @plotfiles;
    for my $r (@rl) {
        if($r =~ /^gnuplot -c stats\/([^ ]*)/) {
            push @plotfiles, $1;
        }
    }

    return @plotfiles;
}

sub graphs {
    my ($tag, @files)=@_;

    my $c =0;
    for my $f (@files) {
        open(G, "git show $tag:$f 2>/dev/null |");
        my @rl = <G>;
        close(G);
        my $pre = $c;
        for my $r (@rl) {
            while($r =~ s/tmp\///) {
                $c++;
            }
        }
    }
    return $c;
}

sub today {
    my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) =
        localtime(time);
    return sprintf "%04d-%02d-%02d", $year + 1900, $mon + 1, $mday;
}

# add current count

$t=`git log --oneline -1 | cut -d" " -f1`;
chomp $t;

my @files = gnuplots($t);
my $gr = graphs($t, @files);
my $files = scalar(@files);
printf "%s;%d;%d\n", today(), $files, $gr;
