#!/usr/bin/perl

require "./stats/tag2date.pm";

sub num {
    my ($t)=@_;
    if($t =~ /^curl-(\d)_(\d+)_(\d+)/) {
        return 10000*$1 + 100*$2 + $3;
    }
    elsif($t =~ /^curl-(\d)_(\d+)/) {
        return 10000*$1 + 100*$2;
    }
}

sub sortthem {
    return num($a) <=> num($b);
}

@alltags= `git tag -l`;

foreach my $t (@alltags) {
    chomp $t;
    if($t =~ /^curl-([0-9_]*[0-9])\z/) {
        push @releases, $t;
    }
}

sub complexity {
    my ($tag, $path) = @_;

    # Get source files to count
    my @files;
    open(G, "git ls-tree -r --name-only $tag -- $path 2>/dev/null|");
    while(<G>) {
        chomp;
        if($_ =~ /[ch]\z/) {
            push @files, $_;
        }
    }
    close(G);

    my $cmd;
    for(@files) {
        $cmd .= "$tag:$_ ";
    }

    #  Modified McCabe Cyclomatic Complexity
    #  |   Traditional McCabe Cyclomatic Complexity
    #  |       |    # Statements in function
    #  |       |        |   First line of function
    #  |       |        |       |   # lines in function
    #  |       |        |       |       |

    my @score;
    my $funcs;
    my $totlines;

    open(G, "git show $cmd 2>/dev/null| pmccabe 2>/dev/null|");
    while(<G>) {
        if($_ =~ /^(\d+)\t(\d+)\t(\d+)\t(\d+)\t(\d+)/) {
            my ($modmccabe, $mccabe, $statements, $first, $lines)=($1, $2, $3, $4, $5);
            if($modmccabe > 1000) {
                # something is wrong
                #print STDERR $_;
                return 0;
            }

            my $step;
            if($modmccabe <= 15) {
                $step = 0;
            }
            elsif($modmccabe <= 50) {
                $step = 1;
            }
            elsif($modmccabe <= 75) {
                $step = 2;
            }
            elsif($modmccabe <= 100) {
                $step = 3;
            }
            elsif($modmccabe <= 200) {
                $step = 4;
            }
            else {
                $step = 5;
            }
            $score[$step] += $lines;
            $totlines += $lines;
        }
    }
    close(G);
    my @share;
    my $acc;
    for my $s (0 .. 5) {
        $share[$s] = ($score[$s]*100 / $totlines) + $acc;
        $acc += ($score[$s]*100 / $totlines);
    }
    return @share;
}

print <<CACHE
2000-03-14;43.014;63.828;79.769;87.980;100.000;100.000
2000-03-21;43.051;63.838;79.777;87.986;100.000;100.000
2000-03-21;43.391;64.054;76.703;88.058;100.000;100.000
2000-08-21;46.784;66.779;78.241;93.945;100.000;100.000
2000-08-30;46.888;66.911;78.340;93.964;100.000;100.000
2000-09-28;48.253;64.195;78.464;88.370;100.000;100.000
2000-10-16;49.035;64.703;78.742;88.585;100.000;100.000
2000-12-04;48.698;65.045;76.714;88.474;100.000;100.000
2001-01-05;49.453;65.530;77.006;88.601;100.000;100.000
2001-01-27;42.141;59.905;73.094;86.632;100.000;100.000
2001-02-13;41.217;58.708;71.438;84.754;100.000;100.000
2001-03-22;40.457;61.747;73.504;82.485;100.000;100.000
2001-04-04;39.989;61.751;73.443;82.376;100.000;100.000
2001-04-23;39.901;61.846;73.447;82.371;100.000;100.000
2001-05-07;39.725;61.884;73.431;82.312;100.000;100.000
2001-06-07;39.190;61.477;73.130;81.972;100.000;100.000
2001-08-20;39.261;61.677;69.178;78.726;100.000;100.000
2001-09-25;41.401;63.871;71.022;77.261;100.000;100.000
2001-11-04;41.774;66.743;75.267;83.984;100.000;100.000
2001-12-05;41.061;67.279;75.505;84.037;100.000;100.000
2002-01-23;42.804;68.855;76.740;84.988;100.000;100.000
2002-02-05;42.757;68.849;76.715;84.933;100.000;100.000
2002-03-07;42.851;68.798;74.971;84.990;100.000;100.000
2002-04-15;43.059;69.043;75.161;85.201;100.000;100.000
2002-05-13;42.694;69.384;75.375;85.261;100.000;100.000
2002-06-13;41.506;68.842;73.266;84.897;100.000;100.000
2002-10-01;40.902;69.966;76.031;84.952;100.000;100.000
2002-10-11;40.818;70.100;76.140;85.024;100.000;100.000
2002-11-18;40.712;69.817;75.809;84.623;100.000;100.000
2003-01-14;41.129;69.950;75.850;84.552;100.000;100.000
2003-04-02;43.487;68.335;74.283;83.420;100.000;100.000
2003-05-19;42.213;68.354;74.209;83.460;100.000;100.000
2003-07-28;43.782;69.140;74.720;83.558;95.098;100.000
2003-08-15;45.179;69.745;75.353;84.047;95.192;100.000
2003-11-01;44.390;70.893;76.354;84.983;100.000;100.000
2004-01-22;44.664;71.101;76.679;81.512;100.000;100.000
2004-03-18;45.415;75.203;81.543;86.942;100.000;100.000
2004-04-26;44.456;72.400;77.688;82.165;100.000;100.000
2004-06-02;44.184;73.323;78.298;81.087;100.000;100.000
2004-08-10;45.342;73.260;78.409;81.172;100.000;100.000
2004-10-18;45.553;73.606;78.676;81.378;96.099;100.000
2004-12-20;46.813;74.011;78.824;81.417;96.261;100.000
2005-02-01;47.051;71.840;78.895;81.461;96.316;100.000
2005-03-04;49.150;75.142;79.625;82.095;96.433;100.000
2005-04-05;47.766;75.248;79.702;82.155;96.457;100.000
2005-05-16;47.836;75.790;80.148;82.543;93.292;100.000
2005-09-01;47.864;74.999;80.223;82.585;93.329;100.000
2005-10-13;48.491;75.273;80.430;82.750;93.434;100.000
2005-12-06;47.995;75.340;80.470;82.770;93.484;100.000
2006-02-27;48.243;75.511;80.650;82.924;93.531;100.000
2006-03-20;48.242;75.523;80.660;82.932;93.534;100.000
2006-06-12;49.777;77.802;81.597;83.750;93.813;100.000
2006-08-07;49.674;76.780;81.674;83.813;93.806;100.000
2006-10-29;48.461;80.289;82.414;84.499;93.880;100.000
2007-01-29;48.152;80.707;82.790;84.802;93.935;100.000
2007-04-11;47.586;80.621;81.845;85.217;94.104;100.000
2007-06-25;47.952;80.577;82.343;85.668;94.244;100.000
2007-07-10;47.929;80.775;82.515;85.806;94.295;100.000
2007-09-13;47.884;79.750;80.542;83.780;94.329;100.000
2007-10-29;48.222;76.861;80.699;83.880;94.403;100.000
2008-01-28;48.286;76.190;80.765;83.882;94.461;100.000
2008-03-30;48.135;76.797;81.864;85.322;94.467;100.000
2008-06-04;48.203;76.795;81.887;85.362;94.502;100.000
2008-09-01;47.669;78.421;83.591;86.644;97.471;100.000
2008-11-05;49.166;78.586;83.775;86.799;94.118;100.000
2008-11-13;49.151;78.554;83.747;86.776;94.108;100.000
2009-01-19;48.691;78.459;83.718;86.736;94.027;100.000
2009-03-02;48.211;76.348;84.246;87.150;94.229;100.000
2009-05-18;47.874;76.388;84.282;87.185;94.237;100.000
2009-08-12;47.798;75.360;83.984;86.865;93.924;100.000
2009-11-04;47.306;74.533;83.917;86.916;92.057;100.000
2010-02-09;49.811;74.862;84.251;87.764;92.647;100.000
2010-04-14;50.123;75.148;84.456;87.933;92.764;100.000
2010-06-16;49.817;75.322;84.162;86.276;93.165;100.000
2010-08-11;49.916;75.439;84.144;86.243;93.152;100.000
2010-10-12;50.296;75.220;84.182;86.272;93.177;100.000
2010-12-15;50.394;74.874;84.210;86.290;93.198;100.000
2011-02-17;50.301;75.322;84.443;86.457;93.294;100.000
2011-04-17;50.260;75.459;84.538;86.561;93.333;100.000
2011-04-22;50.220;75.318;84.388;86.411;93.257;100.000
2013-04-12;53.353;76.758;82.508;84.995;91.539;100.000
2013-06-22;53.400;77.104;82.782;85.235;91.670;100.000
2013-08-11;53.647;77.726;83.233;85.614;91.880;100.000
2013-10-13;54.210;77.749;83.243;85.612;91.850;100.000
2013-12-16;53.983;77.887;83.308;85.667;91.881;100.000
2014-01-29;54.004;77.950;83.343;85.690;91.919;100.000
2014-03-26;54.134;78.138;83.798;86.100;92.253;100.000
2014-05-20;54.202;78.604;83.834;86.123;92.271;100.000
2014-07-16;54.110;78.035;83.921;86.195;92.309;100.000
2014-09-10;53.943;78.376;84.147;86.401;92.457;100.000
2014-11-05;53.545;78.096;84.029;86.307;92.413;100.000
2015-01-07;53.985;78.666;84.437;86.646;92.605;100.000
2015-02-25;53.356;78.240;84.136;86.384;92.464;100.000
2015-04-22;53.097;77.644;84.179;86.414;92.456;100.000
2015-04-28;53.296;77.633;84.174;86.408;92.450;100.000
2015-06-17;53.312;77.262;83.901;86.513;92.511;100.000
2015-08-11;53.383;77.356;83.980;86.582;92.540;100.000
2015-10-07;53.025;77.312;83.965;86.565;92.535;100.000
2015-12-01;52.509;77.479;84.081;86.660;92.617;100.000
2016-01-27;52.548;77.476;84.060;86.694;92.623;100.000
2016-02-08;52.415;77.551;84.121;86.749;92.664;100.000
2016-03-23;52.393;77.602;84.143;86.758;92.675;100.000
2016-05-17;51.767;77.304;83.481;86.337;92.649;100.000
2016-05-30;51.799;77.318;83.489;86.343;92.651;100.000
2016-07-21;51.636;77.397;83.524;86.370;92.666;100.000
2016-08-03;51.643;77.400;83.525;86.372;92.667;100.000
2016-09-07;51.637;77.421;83.534;86.387;92.687;100.000
2016-09-14;51.641;77.418;83.530;86.391;92.688;100.000
2016-11-02;51.751;77.384;83.512;86.373;92.689;100.000
2016-12-20;51.507;76.990;83.275;85.415;92.626;100.000
2016-12-22;51.507;76.990;83.275;85.415;92.626;100.000
2017-02-22;51.273;76.476;82.725;85.350;92.585;100.000
2017-02-24;51.266;76.462;82.710;85.334;92.572;100.000
2017-04-19;51.594;76.841;83.633;86.241;92.678;100.000
2017-06-14;51.556;76.907;83.667;86.276;92.708;100.000
2017-08-09;51.465;76.135;84.149;86.212;92.645;100.000
2017-08-13;51.469;76.158;84.166;86.227;92.652;100.000
2017-10-04;51.679;75.830;84.402;85.895;92.760;100.000
2017-10-23;51.635;75.748;84.295;85.782;90.095;100.000
2017-11-29;51.717;75.839;83.795;85.860;90.117;100.000
2018-01-23;51.281;75.090;82.807;84.817;90.434;100.000
2018-03-13;51.317;75.135;82.828;84.833;90.426;100.000
2018-05-15;51.204;75.318;82.903;84.887;90.444;100.000
2018-07-11;51.148;75.394;82.943;84.922;90.444;100.000
2018-09-04;50.734;75.384;82.947;84.915;90.407;100.000
2018-10-30;50.499;75.756;83.874;85.218;90.581;100.000
2018-12-12;50.487;75.608;83.798;85.149;90.544;100.000
2019-02-06;50.213;75.778;83.882;85.219;90.618;100.000
2019-03-27;50.066;76.031;83.788;85.122;90.604;100.000
2019-05-22;49.951;76.155;83.802;85.111;90.497;100.000
2019-06-04;49.993;76.178;83.820;85.128;90.508;100.000
2019-07-17;50.283;76.211;83.850;85.158;90.533;100.000
2019-07-19;50.293;76.209;83.848;85.156;90.532;100.000
2019-09-10;50.563;77.246;84.472;86.068;91.303;100.000
2019-11-05;50.752;77.284;84.499;86.095;91.326;100.000
2020-01-08;50.482;77.474;84.594;86.541;91.335;100.000
2020-03-04;50.561;77.118;84.212;86.638;91.400;100.000
2020-03-11;50.431;77.144;84.225;86.648;91.400;100.000
2020-04-29;50.410;76.882;84.365;86.770;91.475;100.000
2020-06-23;50.206;76.031;83.062;86.755;91.428;100.000
2020-06-30;50.272;76.316;83.062;86.756;91.428;100.000
2020-08-19;50.345;76.082;83.105;86.793;91.452;100.000
2020-10-14;50.054;75.726;83.021;86.361;91.402;100.000
2020-12-09;50.100;76.097;83.037;85.661;91.394;100.000
2021-02-03;50.094;76.705;84.510;87.703;92.511;100.000
2021-03-31;50.031;76.810;84.480;87.727;92.472;100.000
2021-04-14;50.060;76.833;84.114;87.754;92.476;100.000
2021-05-26;50.344;76.584;84.592;87.322;92.420;100.000
2021-07-21;50.135;76.936;85.002;87.718;92.489;100.000
2021-09-14;50.147;77.000;85.037;87.765;92.521;100.000
2021-09-22;50.153;77.003;85.039;87.766;92.522;100.000
2021-11-10;50.183;76.678;85.095;87.794;92.523;100.000
2022-01-05;50.293;76.460;85.138;87.837;92.542;100.000
2022-03-05;50.827;76.269;85.008;87.711;92.468;100.000
2022-04-27;50.967;76.436;85.105;87.795;92.514;100.000
2022-05-11;50.957;76.441;85.111;87.798;92.517;100.000
2022-06-27;50.870;76.411;84.838;87.831;92.532;100.000
2022-08-31;51.122;76.357;84.410;87.900;92.564;100.000
2022-10-26;51.120;76.508;84.210;87.570;92.700;100.000
2022-12-21;52.122;77.745;85.366;88.296;92.748;100.000
2023-02-15;53.010;78.774;86.023;88.611;92.937;100.000
2023-02-20;52.980;78.767;86.012;88.600;92.924;100.000
2023-03-20;53.076;78.838;86.063;88.638;92.957;100.000
2023-03-20;53.070;78.841;86.067;88.642;92.956;100.000
2023-05-17;54.492;79.517;87.032;88.981;93.149;100.000
2023-05-23;54.483;79.520;87.034;88.982;93.150;100.000
2023-05-30;54.408;79.506;87.019;88.968;93.146;100.000
2023-07-19;54.104;79.551;87.058;88.998;93.152;100.000
2023-07-26;54.100;79.551;87.059;88.999;93.152;100.000
2023-09-13;53.540;78.864;86.532;88.745;92.969;100.000
2023-10-11;53.390;78.904;86.558;88.765;92.971;100.000
2023-12-06;53.454;79.668;86.591;88.906;93.054;100.000
2024-01-31;54.454;80.380;87.224;89.455;93.514;100.000
2024-03-27;55.579;80.807;87.784;90.016;93.574;100.000
2024-03-27;55.579;80.807;87.784;90.016;93.574;100.000
2024-05-22;56.081;80.639;87.522;90.103;93.592;100.000
2024-07-24;56.628;80.822;88.075;90.252;93.675;100.000
2024-07-31;56.647;80.831;88.084;90.259;93.679;100.000
2024-09-11;56.981;81.176;88.176;90.579;93.641;100.000
2024-09-18;56.973;81.192;88.188;90.590;93.650;100.000
2024-11-06;57.592;82.976;90.843;93.872;98.078;100.000
2024-12-11;57.920;83.719;91.579;94.152;99.332;100.000
2025-02-05;58.040;83.437;91.483;94.177;99.337;100.000
2025-02-13;58.065;83.442;91.498;94.198;99.342;100.000
2025-04-02;59.068;83.312;91.826;94.312;100.000;100.000
CACHE
    ;

sub show {
    my ($t, $d) = @_;
    my @share = complexity($t, "src lib");
    if($share[0]) {
        print "$d";
        for my $ss (@share) {
            printf ";%.3f", $ss;
        }
        print "\n";
    }

}

foreach my $t (sort sortthem @releases) {
    if(num($t) <= 81300) {
        next;
    }
    my $d = tag2date($t);
    show($t, $d);
}

$t=`git describe --match "curl*"`;
chomp $t;

my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) =
    localtime(time);
my $d = sprintf "%04d-%02d-%02d", $year + 1900, $mon + 1, $mday;

show($t, $d);
