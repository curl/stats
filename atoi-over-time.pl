#!/usr/bin/perl

require "./stats/tag2date.pm";

sub num {
    my ($t)=@_;
    if($t =~ /^curl-(\d)_(\d+)_(\d+)/) {
        return 10000*$1 + 100*$2 + $3;
    }
    elsif($t =~ /^curl-(\d)_(\d+)/) {
        return 10000*$1 + 100*$2;
    }
}


sub sortthem {
    return num($a) <=> num($b);
}

@alltags= `git tag -l`;

foreach my $t (@alltags) {
    chomp $t;
    if($t =~ /^curl-([0-9_]*[0-9])\z/) {
        push @releases, $t;
    }
}

sub atoiuse {
    my ($tag, $path) = @_;

    # Get source files to count
    my @files;
    open(G, "git ls-tree -r --name-only $tag -- $path 2>/dev/null|");
    while(<G>) {
        chomp;
        if($_ =~ /[ch]\z/) {
            push @files, $_;
        }
    }
    close(G);

    my $cmd;
    for(@files) {
        $cmd .= "$tag:$_ ";
    }

    my $count;
    my $alloc;

    open(G, "git show $cmd 2>/dev/null| grep -E ' (atoi|strtol|strtoul|strtoll)\\(' 2>/dev/null|");
    while(<G>) {
        $count++;
    }
    close(G);

    return ($count);
}

print <<CACHE
2000-03-14;18
2000-03-21;18
2000-03-21;18
2000-08-21;18
2000-08-30;18
2000-09-28;17
2000-10-16;17
2000-12-04;18
2001-01-05;18
2001-01-27;17
2001-02-13;17
2001-03-22;18
2001-04-04;18
2001-04-23;18
2001-05-07;19
2001-06-07;19
2001-08-20;19
2001-09-25;18
2001-11-04;18
2001-12-05;18
2002-01-23;18
2002-02-05;18
2002-03-07;18
2002-04-15;18
2002-05-13;18
2002-06-13;17
2002-10-01;18
2002-10-11;18
2002-11-18;18
2003-01-14;18
2003-04-02;18
2003-05-19;18
2003-07-28;19
2003-08-15;20
2003-11-01;16
2004-01-22;17
2004-03-18;10
2004-04-26;15
2004-06-02;16
2004-08-10;16
2004-10-18;17
2004-12-20;17
2005-02-01;17
2005-03-04;18
2005-04-05;18
2005-05-16;18
2005-09-01;18
2005-10-13;18
2005-12-06;18
2006-02-27;18
2006-03-20;18
2006-06-12;18
2006-08-07;18
2006-10-29;18
2007-01-29;18
2007-04-11;21
2007-06-25;21
2007-07-10;21
2007-09-13;20
2007-10-29;20
2008-01-28;20
2008-03-30;20
2008-06-04;20
2008-09-01;19
2008-11-05;19
2008-11-13;19
2009-01-19;19
2009-03-02;21
2009-05-18;21
2009-08-12;20
2009-11-04;20
2010-02-09;21
2010-04-14;21
2010-06-16;23
2010-08-11;23
2010-10-12;23
2010-12-15;22
2011-02-17;22
2011-04-17;22
2011-04-22;22
2011-06-23;22
2011-09-13;21
2011-11-14;21
2011-11-17;21
2012-01-24;21
2012-03-22;22
2012-05-24;22
2012-07-27;22
2012-10-10;22
2012-11-20;22
2013-02-06;23
2013-04-12;25
2013-06-22;25
2013-08-11;25
2013-10-13;29
2013-12-16;29
2014-01-29;28
2014-03-26;28
2014-05-20;29
2014-07-16;29
2014-09-10;29
2014-11-05;29
2015-01-07;29
2015-02-25;29
2015-04-22;29
2015-04-28;29
2015-06-17;29
2015-08-11;29
2015-10-07;29
2015-12-01;29
2016-01-27;29
2016-02-08;29
2016-03-23;29
2016-05-17;31
2016-05-30;31
2016-07-21;31
2016-08-03;31
2016-09-07;31
2016-09-14;31
2016-11-02;32
2016-12-20;32
2016-12-22;32
2017-02-22;32
2017-02-24;32
2017-04-19;32
2017-06-14;32
2017-08-09;32
2017-08-13;32
2017-10-04;34
2017-10-23;34
2017-11-29;34
2018-01-23;35
2018-03-13;36
2018-05-15;36
2018-07-11;37
2018-09-04;37
2018-10-30;39
2018-12-12;39
2019-02-06;39
2019-03-27;42
2019-05-22;42
2019-06-04;42
2019-07-17;42
2019-07-19;42
2019-09-10;42
2019-11-05;42
2020-01-08;42
2020-03-04;43
2020-03-11;43
2020-04-29;47
2020-06-23;47
2020-06-30;47
2020-08-19;47
2020-10-14;47
2020-12-09;48
2021-02-03;46
2021-03-31;46
2021-04-14;46
2021-05-26;46
2021-07-21;45
2021-09-14;45
2021-09-22;45
2021-11-10;45
2022-01-05;45
2022-03-05;45
2022-04-27;46
2022-05-11;46
2022-06-27;46
2022-08-31;46
2022-10-26;47
2022-12-21;47
2023-02-15;46
2023-02-20;47
2023-03-20;56
2023-03-20;56
2023-05-17;59
2023-05-23;59
2023-05-30;59
2023-07-19;60
2023-07-26;60
2023-09-13;63
2023-10-11;65
2023-12-06;65
2024-01-31;63
2024-03-27;64
2024-03-27;64
2024-05-22;64
2024-07-24;63
2024-07-31;63
2024-09-11;63
2024-09-18;63
2024-11-06;63
2024-12-11;63
2025-02-05;64
2025-02-13;64
2025-04-02;6
2025-05-28;6
2025-06-04;6
2025-07-16;6
2025-09-10;6
2025-11-05;5
CACHE
    ;

sub show {
    my ($t, $d) = @_;
    my $atoi = atoiuse($t, "lib src");
    printf "$d;%u\n", $atoi;
}

foreach my $t (sort sortthem @releases) {
    if(num($t) <= 81700) {
        next;
    }
    my $d = tag2date($t);
    show($t, $d);
}

$t=`git describe --match "curl*"`;
chomp $t;

my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) =
    localtime(time);
my $d = sprintf "%04d-%02d-%02d", $year + 1900, $mon + 1, $mday;

show($t, $d);
